<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>rPPG Liveness Detection</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,.3); overflow: hidden; }
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 32px 40px; }
.header h1 { font-size: 32px; margin-bottom: 8px; font-weight: 700; }
.header p { opacity: .9; font-size: 14px; }
.main-content { display: grid; grid-template-columns: 1.4fr 1fr; gap: 30px; padding: 30px; }
.video-panel { display: flex; flex-direction: column; gap: 20px; }
.video-container { position: relative; background: #000; border-radius: 16px; overflow: hidden; aspect-ratio: 4/3; border: 4px solid #e0e0e0; transition: all .3s; }
.video-container.analyzing { border-color: #ffc107; box-shadow: 0 0 40px rgba(255,193,7,.4); }
.video-container.verified { border-color: #4caf50; box-shadow: 0 0 40px rgba(76,175,80,.5); }
.video-container.rejected { border-color: #f44336; box-shadow: 0 0 40px rgba(244,67,54,.5); }
#webcam, #canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
.status-badge { position: absolute; top: 16px; left: 16px; background: rgba(0,0,0,.85); backdrop-filter: blur(10px); padding: 10px 16px; border-radius: 8px; z-index: 10; color: white; font-weight: 600; }
.status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .6; } }
.dot-idle { background: #9e9e9e; } .dot-analyzing { background: #ffc107; } .dot-verified { background: #4caf50; } .dot-rejected { background: #f44336; }
.ppg-compact { position: absolute; bottom: 16px; left: 16px; right: 16px; background: rgba(0,0,0,.9); padding: 12px 16px; border-radius: 8px; z-index: 10; border: 2px solid rgba(76,175,80,.5); color: white; }
.ppg-waveform { height: 50px; width: 100%; margin-top: 8px; }
.control-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.btn { padding: 16px 24px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all .2s; }
.btn:disabled { opacity: .5; cursor: not-allowed; }
.btn:not(:disabled):hover { transform: translateY(-2px); }
.btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); color: white; }
.btn-danger { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
.btn-full { grid-column: 1 / -1; }
.method-selector { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196f3; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
.method-selector h3 { color: #1565c0; font-size: 16px; margin-bottom: 16px; font-weight: 700; }
.method-option { display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; }
.method-badge { padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; color: white; }
.badge-fast { background: #ffc107; } .badge-accurate { background: #4caf50; } .badge-best { background: #9c27b0; }
.neural-status { margin-top: 12px; padding: 12px; background: rgba(33, 150, 243, 0.1); border-radius: 8px; font-size: 13px; color: #1565c0; }
.info-panel { display: flex; flex-direction: column; gap: 20px; }
.card { background: #f8f9fa; border-radius: 12px; padding: 20px; border-left: 4px solid #667eea; }
.card-title { font-size: 16px; font-weight: 700; color: #2c3e50; margin-bottom: 16px; }
.progress-ring { position: relative; width: 120px; height: 120px; margin: 0 auto 16px; }
.progress-ring svg { transform: rotate(-90deg); }
.progress-ring-circle { stroke: #e0e0e0; fill: none; stroke-width: 8; }
.progress-ring-fill { stroke: #667eea; fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset .5s; }
.progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
.progress-value { font-size: 32px; font-weight: 700; color: #667eea; }
.metric-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.metric-box { background: white; padding: 16px; border-radius: 10px; text-align: center; }
.metric-value { font-size: 28px; font-weight: 700; color: #667eea; }
.metric-label { font-size: 11px; color: #666; text-transform: uppercase; }
.stat-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e0e0e0; }
.stat-row:last-child { border-bottom: none; }
.test-item { display: flex; justify-content: space-between; padding: 10px; background: white; border-radius: 8px; margin-bottom: 8px; }
.test-status { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
.status-pass { background: #d4edda; color: #155724; } .status-fail { background: #f8d7da; color: #721c24; } .status-pending { background: #e0e0e0; color: #666; }
.alert { padding: 16px 20px; border-radius: 10px; font-size: 14px; margin-bottom: 10px; }
.alert-success { background: #d4edda; color: #155724; } .alert-error { background: #f8d7da; color: #721c24; } .alert-warning { background: #fff3cd; color: #856404; }
.loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.9); display: none; align-items: center; justify-content: center; z-index: 9999; color: white; flex-direction: column; gap: 20px; }
.spinner { width: 50px; height: 50px; border: 4px solid #333; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
@media (max-width: 1200px) { .main-content { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div><div style="font-size:18px;font-weight:600">Initializing...</div><div style="font-size:14px;opacity:.8" id="loadText">Loading...</div></div>
<div class="container">
<div class="header"><h1>üõ° Advanced rPPG Liveness Detection</h1><p>Enterprise-Grade Anti-Spoofing System | Two-Input Neural Network</p></div>
<div class="main-content">
<div class="video-panel">
<div class="video-container" id="videoContainer">
<video id="webcam" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>
<div class="status-badge"><span class="status-dot dot-idle" id="statusDot"></span><span id="statusText">READY</span></div>
<div class="ppg-compact"><div>BVP: <span id="compactBVP">--</span> | Samples: <span id="compactSamples">0</span></div><canvas id="ppgWaveform" class="ppg-waveform"></canvas></div>
</div>
<div class="control-panel">
<button id="startBtn" class="btn btn-primary btn-full">üé• Start Camera</button>
<button id="analyzeBtn" class="btn btn-success" disabled>üîç Start Analysis</button>
<button id="stopBtn" class="btn btn-danger" disabled>‚èπ Stop</button>
</div>
<div class="method-selector">
<h3>üî¨ Detection Method</h3>
<div class="method-option"><input type="radio" id="methodGMM" name="detectionMethod" value="gmm"><label for="methodGMM">GMM Classifier</label><span class="method-badge badge-fast">FAST</span></div>
<div class="method-option"><input type="radio" id="methodNeural" name="detectionMethod" value="neural"><label for="methodNeural">Neural Network</label><span class="method-badge badge-accurate">98.27% AUC</span></div>
<div class="method-option"><input type="radio" id="methodHybrid" name="detectionMethod" value="hybrid" checked><label for="methodHybrid">Hybrid Mode</label><span class="method-badge badge-best">BEST</span></div>
<div class="neural-status" id="neuralStatus">üîÑ Loading...</div>
</div>
<div id="alertBox"></div>
</div>
<div class="info-panel">
<div class="card">
<div class="card-title">üéØ Liveness Confidence</div>
<div class="progress-ring"><svg width="120" height="120"><circle class="progress-ring-circle" cx="60" cy="60" r="52"></circle><circle id="progressCircle" class="progress-ring-fill" cx="60" cy="60" r="52" stroke-dasharray="326.73" stroke-dashoffset="326.73"></circle></svg><div class="progress-text"><div class="progress-value" id="confidenceValue">0%</div></div></div>
<div class="metric-grid">
<div class="metric-box"><div class="metric-value" id="gmmScore">--</div><div class="metric-label">GMM</div></div>
<div class="metric-box"><div class="metric-value" id="neuralScore">--</div><div class="metric-label">Neural</div></div>
<div class="metric-box"><div class="metric-value" id="depthScore">--</div><div class="metric-label">Depth</div></div>
</div>
</div>
<div class="card">
<div class="card-title">üìä Metrics</div>
<div class="stat-row"><span>Time:</span><span id="duration">0.0s</span></div>
<div class="stat-row"><span>Method:</span><span id="currentMethod">Hybrid</span></div>
<div class="stat-row"><span>1st Deriv:</span><span id="derivValue">--</span></div>
<div class="stat-row"><span>Embedding:</span><span id="embeddingConsistency">--</span></div>
</div>
<div class="card">
<div class="card-title">üß™ Tests</div>
<div class="test-item"><span>‚úì GMM</span><span class="test-status status-pending" id="test1">Pending</span></div>
<div class="test-item"><span>‚úì Neural</span><span class="test-status status-pending" id="test2">Pending</span></div>
<div class="test-item"><span>‚úì Consistency</span><span class="test-status status-pending" id="test3">Pending</span></div>
<div class="test-item"><span>‚úì Depth</span><span class="test-status status-pending" id="test4">Pending</span></div>
</div>
</div>
</div>
</div>

<script>
const MODEL_URL='https://aero34317-coder.github.io/PPG_tfjs_model/model.json';
const CFG={FPS:30,MIN_SAMPLES:150,NEURAL_SAMPLES:1024,CONFIDENCE_THRESHOLD:45,BANDPASS_LOW:0.5,BANDPASS_HIGH:8.0,GMM_FAKE_THRESHOLD:1300,GMM_REAL_THRESHOLD:2000,DEPTH_TEMPORAL_THRESHOLD:0.00015,EMBEDDING_CONSISTENCY_THRESHOLD:0.85};
const STATE={faceMesh:null,videoStream:null,animationFrameId:null,isAnalyzing:false,startTime:null,neuralModel:null,neuralModelLoaded:false,detectionMethod:'hybrid',rSignal:[],gSignal:[],bSignal:[],posSignal:[],depthHistory:[],firstDerivVariance:0,embeddings:[],embeddingConsistency:0,temporalDepthVariance:0,isStaticDepth:false,metricsInterval:null};
const E={webcam:document.getElementById('webcam'),canvas:document.getElementById('canvas'),videoContainer:document.getElementById('videoContainer'),statusDot:document.getElementById('statusDot'),statusText:document.getElementById('statusText'),ppgWaveform:document.getElementById('ppgWaveform'),compactBVP:document.getElementById('compactBVP'),compactSamples:document.getElementById('compactSamples'),startBtn:document.getElementById('startBtn'),analyzeBtn:document.getElementById('analyzeBtn'),stopBtn:document.getElementById('stopBtn'),alertBox:document.getElementById('alertBox'),confidenceValue:document.getElementById('confidenceValue'),progressCircle:document.getElementById('progressCircle'),gmmScore:document.getElementById('gmmScore'),neuralScore:document.getElementById('neuralScore'),depthScore:document.getElementById('depthScore'),duration:document.getElementById('duration'),derivValue:document.getElementById('derivValue'),embeddingConsistency:document.getElementById('embeddingConsistency'),currentMethod:document.getElementById('currentMethod'),test1:document.getElementById('test1'),test2:document.getElementById('test2'),test3:document.getElementById('test3'),test4:document.getElementById('test4'),loadingOverlay:document.getElementById('loadingOverlay'),loadText:document.getElementById('loadText'),neuralStatus:document.getElementById('neuralStatus')};

function calculateMean(a){return a.length?a.reduce((x,y)=>x+y,0)/a.length:0}
function calculateStd(a){const m=calculateMean(a);return Math.sqrt(a.reduce((s,v)=>s+Math.pow(v-m,2),0)/a.length)}
function normalizeSignal(a){const m=calculateMean(a),s=calculateStd(a);return s===0?a.map(()=>0):a.map(v=>(v-m)/s)}
function cosineSimilarity(a,b){if(a.length!==b.length)return 0;let d=0,nA=0,nB=0;for(let i=0;i<a.length;i++){d+=a[i]*b[i];nA+=a[i]*a[i];nB+=b[i]*b[i]}nA=Math.sqrt(nA);nB=Math.sqrt(nB);return(nA>0&&nB>0)?d/(nA*nB):0}
function lightBandpassFilter(s,fps,low,high){if(s.length<10)return s;const m=calculateMean(s);let f=s.map(v=>v-m);const w=Math.max(3,Math.floor(fps/high)),sm=[];for(let i=0;i<f.length;i++){const st=Math.max(0,i-Math.floor(w/2)),en=Math.min(f.length,i+Math.ceil(w/2));sm.push(calculateMean(f.slice(st,en)))}return sm}

function extractPPG(img,lm){const c=document.createElement('canvas'),ctx=c.getContext('2d');c.width=img.width;c.height=img.height;ctx.drawImage(img,0,0);const regions=[[10,338,297,332,284,251,389,356,454,323,361,288],[205,50,123,132,177,147,187,207,216,206],[425,280,352,361,401,376,411,427,436,426]];let tR=0,tG=0,tB=0,pc=0;for(const r of regions){for(const i of r){const p=lm[i],x=Math.floor(p.x*c.width),y=Math.floor(p.y*c.height);if(x>=0&&x<c.width&&y>=0&&y<c.height){const px=ctx.getImageData(x,y,1,1).data;tR+=px[0];tG+=px[1];tB+=px[2];pc++}}}return pc?{r:tR/pc,g:tG/pc,b:tB/pc}:{r:0,g:0,b:0}}

function processPOS(){if(STATE.rSignal.length<CFG.MIN_SAMPLES)return null;const rN=normalizeSignal(STATE.rSignal),gN=normalizeSignal(STATE.gSignal),bN=normalizeSignal(STATE.bSignal),posRaw=[];for(let i=0;i<rN.length;i++){posRaw.push(3.0*gN[i]-1.5*rN[i]-1.5*bN[i])}STATE.posSignal=lightBandpassFilter(posRaw,CFG.FPS,CFG.BANDPASS_LOW,CFG.BANDPASS_HIGH);return STATE.posSignal}

function analyzeWaveformDerivatives(){if(STATE.rSignal.length<90)return null;const rec=STATE.rSignal.slice(-90),nR=rec.map(v=>v-calculateMean(rec)),nG=STATE.gSignal.slice(-90).map(v=>v-calculateMean(STATE.gSignal.slice(-90))),nB=STATE.bSignal.slice(-90).map(v=>v-calculateMean(STATE.bSignal.slice(-90))),raw=[];for(let i=0;i<nR.length;i++){raw.push(3.0*nG[i]-1.5*nR[i]-1.5*nB[i])}const fd=[];for(let i=1;i<raw.length;i++){fd.push(Math.abs(raw[i]-raw[i-1]))}STATE.firstDerivVariance=calculateMean(fd)*1000;return{firstDerivVariance:STATE.firstDerivVariance}}

function findPeaks(s){const p=[];const md=Math.floor(0.4*CFG.FPS);let lp=-md;for(let i=1;i<s.length-1;i++){if(s[i]>s[i-1]&&s[i]>s[i+1]&&i-lp>=md&&s[i]>0.5){p.push(i);lp=i}}return p}

function extractMorphologicalFeatures(s){const f=new Array(20).fill(0);try{const p=findPeaks(s);if(p.length<2)return f;const ppi=[];for(let i=1;i<p.length;i++){ppi.push((p[i]-p[i-1])/CFG.FPS)}if(ppi.length>0){f[0]=calculateMean(ppi);f[1]=calculateStd(ppi);f[2]=Math.max(...ppi);f[3]=Math.min(...ppi)}const amp=p.map(x=>s[x]);f[6]=calculateMean(amp);f[7]=calculateStd(amp);f[15]=calculateMean(s);f[16]=calculateStd(s);f[17]=Math.max(...s);f[18]=Math.min(...s)}catch(e){console.error('Feature error:',e)}return f}

async function loadNeuralModel(){try{E.neuralStatus.textContent='üîÑ Loading...';E.loadText.textContent='Loading model...';console.log('Loading:',MODEL_URL);STATE.neuralModel=await tf.loadLayersModel(MODEL_URL);STATE.neuralModelLoaded=true;console.log('‚úÖ Loaded! Inputs:',STATE.neuralModel.inputs.map(i=>({name:i.name,shape:i.shape})));E.neuralStatus.innerHTML='‚úÖ <strong>Loaded!</strong> 98.27% AUC';E.neuralStatus.style.background='rgba(76,175,80,0.2)';E.neuralStatus.style.color='#2e7d32';const tS=tf.zeros([1,1024,1]),tF=tf.zeros([1,20,1]),tO=STATE.neuralModel.predict([tS,tF]);console.log('‚úÖ Test OK:',tO.shape);tS.dispose();tF.dispose();tO.dispose()}catch(e){console.error('‚ùå Error:',e);E.neuralStatus.innerHTML='‚ö† <strong>Unavailable</strong>';E.neuralStatus.style.background='rgba(255,152,0,0.2)';STATE.neuralModelLoaded=false;document.getElementById('methodGMM').checked=true;STATE.detectionMethod='gmm'}}

async function getNeuralEmbedding(s1024){if(!STATE.neuralModelLoaded)return null;try{const mf=extractMorphologicalFeatures(s1024),sT=tf.tensor3d([s1024.map(v=>[v])]),fT=tf.tensor3d([mf.map(v=>[v])]),emb=STATE.neuralModel.predict([sT,fT]),eArr=await emb.data();sT.dispose();fT.dispose();emb.dispose();return Array.from(eArr)}catch(e){console.error('Emb error:',e);return null}}

async function checkEmbeddingConsistency(){if(STATE.posSignal.length<CFG.NEURAL_SAMPLES*2)return{consistency:0};try{const w1=STATE.posSignal.slice(0,CFG.NEURAL_SAMPLES),w2=STATE.posSignal.slice(Math.floor(CFG.NEURAL_SAMPLES/2),Math.floor(CFG.NEURAL_SAMPLES/2)+CFG.NEURAL_SAMPLES),w3=STATE.posSignal.slice(-CFG.NEURAL_SAMPLES),e1=await getNeuralEmbedding(w1),e2=await getNeuralEmbedding(w2),e3=await getNeuralEmbedding(w3);if(!e1||!e2||!e3)return{consistency:0};const s12=cosineSimilarity(e1,e2),s23=cosineSimilarity(e2,e3),s13=cosineSimilarity(e1,e3);return{consistency:(s12+s23+s13)/3}}catch(e){console.error('Cons error:',e);return{consistency:0}}}

function analyze3DDepth(lm){if(!lm||lm.length<468)return null;const zV=calculateStd([lm[1].z,lm[205].z,lm[425].z]);STATE.depthHistory.push(zV);if(STATE.depthHistory.length>60)STATE.depthHistory.shift();return{zVariance:zV}}

function analyzeTemporalDepthVariance(){if(STATE.depthHistory.length<30)return null;STATE.temporalDepthVariance=calculateStd(STATE.depthHistory.slice(-30));STATE.isStaticDepth=STATE.temporalDepthVariance<CFG.DEPTH_TEMPORAL_THRESHOLD;return{temporalVariance:STATE.temporalDepthVariance}}

async function calculateConfidence(){const m=STATE.detectionMethod;let gC=0,nC=0,dC=0;const fD=STATE.firstDerivVariance||0;if(fD>=CFG.GMM_REAL_THRESHOLD){gC=100}else if(fD>CFG.GMM_FAKE_THRESHOLD){gC=((fD-CFG.GMM_FAKE_THRESHOLD)/(CFG.GMM_REAL_THRESHOLD-CFG.GMM_FAKE_THRESHOLD))*100}else{gC=10}if(STATE.neuralModelLoaded&&STATE.posSignal.length>=CFG.NEURAL_SAMPLES*2){const r=await checkEmbeddingConsistency();STATE.embeddingConsistency=r.consistency;nC=r.consistency*100}const tD=STATE.temporalDepthVariance||0;dC=STATE.isStaticDepth?20:Math.min(100,(tD/CFG.DEPTH_TEMPORAL_THRESHOLD)*100);E.gmmScore.textContent=Math.round(gC);E.neuralScore.textContent=STATE.neuralModelLoaded?Math.round(nC):'--';E.depthScore.textContent=Math.round(dC);E.embeddingConsistency.textContent=STATE.neuralModelLoaded?`${(STATE.embeddingConsistency*100).toFixed(1)}%`:'--';let fC=0;if(m==='gmm'){fC=gC*0.7+dC*0.3;updateTest('test1',gC>50);updateTest('test2',null);updateTest('test3',null)}else if(m==='neural'&&STATE.neuralModelLoaded){fC=nC*0.8+dC*0.2;updateTest('test1',null);updateTest('test2',nC>80);updateTest('test3',STATE.embeddingConsistency>CFG.EMBEDDING_CONSISTENCY_THRESHOLD)}else if(m==='hybrid'){if(gC<25){fC=gC;updateTest('test1',false);updateTest('test2',null);updateTest('test3',null)}else if(STATE.neuralModelLoaded&&nC>0){fC=nC*0.6+gC*0.3+dC*0.1;updateTest('test1',gC>50);updateTest('test2',nC>70);updateTest('test3',STATE.embeddingConsistency>CFG.EMBEDDING_CONSISTENCY_THRESHOLD)}else{fC=gC*0.7+dC*0.3;updateTest('test1',gC>50);updateTest('test2',null);updateTest('test3',null)}}updateTest('test4',dC>50);return Math.max(0,Math.min(100,fC))}

function showAlert(t,m){E.alertBox.innerHTML=`<div class="alert alert-${t}">${m}</div>`;setTimeout(()=>{E.alertBox.innerHTML=''},5000)}
function updateStatus(s,t){E.statusDot.className='status-dot dot-'+s;E.statusText.textContent=t}
function updateConfidence(v){const p=Math.round(v);E.confidenceValue.textContent=p+'%';const c=326.73,o=c-(p/100)*c;E.progressCircle.style.strokeDashoffset=o}
function updateTest(tId,p){const el=E[tId];if(!el)return;if(p===null){el.textContent='Pending';el.className='test-status status-pending'}else if(p){el.textContent='Pass';el.className='test-status status-pass'}else{el.textContent='Fail';el.className='test-status status-fail'}}

function drawWaveform(){if(!STATE.posSignal||STATE.posSignal.length<10)return;const c=E.ppgWaveform,ctx=c.getContext('2d'),w=c.width,h=c.height;ctx.clearRect(0,0,w,h);const s=STATE.posSignal.slice(-120),st=w/s.length,mx=Math.max(...s),mn=Math.min(...s),rg=mx-mn||1;ctx.strokeStyle='#4caf50';ctx.lineWidth=2;ctx.beginPath();for(let i=0;i<s.length;i++){const x=i*st,y=h-((s[i]-mn)/rg)*(h-10)-5;if(i===0){ctx.moveTo(x,y)}else{ctx.lineTo(x,y)}}ctx.stroke()}

function resetState(){Object.assign(STATE,{rSignal:[],gSignal:[],bSignal:[],posSignal:[],depthHistory:[],firstDerivVariance:0,embeddings:[],embeddingConsistency:0,temporalDepthVariance:0,isStaticDepth:false});updateConfidence(0);E.gmmScore.textContent='--';E.neuralScore.textContent='--';E.depthScore.textContent='--';E.compactBVP.textContent='--';E.compactSamples.textContent='0';E.derivValue.textContent='--';E.embeddingConsistency.textContent='--';['test1','test2','test3','test4'].forEach(id=>updateTest(id,null))}

async function updateMetrics(){if(!STATE.isAnalyzing)return;if(STATE.startTime){const el=(Date.now()-STATE.startTime)/1000;E.duration.textContent=el.toFixed(1)+'s'}E.compactSamples.textContent=STATE.rSignal.length;if(STATE.firstDerivVariance>0){E.derivValue.textContent=STATE.firstDerivVariance.toFixed(1)}drawWaveform();const conf=await calculateConfidence();updateConfidence(conf);if(STATE.rSignal.length>=CFG.MIN_SAMPLES){if(conf>=CFG.CONFIDENCE_THRESHOLD){E.videoContainer.className='video-container verified';updateStatus('verified','VERIFIED');showAlert('success','‚úì Real human detected!')}else if(conf<35){E.videoContainer.className='video-container rejected';updateStatus('rejected','REJECTED');showAlert('error','‚úó Spoofing detected!')}else{E.videoContainer.className='video-container analyzing';updateStatus('analyzing','ANALYZING')}}}

function onFaceMeshResults(res){if(!STATE.isAnalyzing)return;const ctx=E.canvas.getContext('2d');ctx.save();ctx.clearRect(0,0,E.canvas.width,E.canvas.height);if(res.multiFaceLandmarks&&res.multiFaceLandmarks.length>0){const lm=res.multiFaceLandmarks[0];const rgb=extractPPG(res.image,lm);STATE.rSignal.push(rgb.r);STATE.gSignal.push(rgb.g);STATE.bSignal.push(rgb.b);if(STATE.rSignal.length>=CFG.MIN_SAMPLES){processPOS();analyzeWaveformDerivatives();analyze3DDepth(lm);analyzeTemporalDepthVariance()}ctx.strokeStyle='rgba(76,175,80,0.3)';ctx.lineWidth=1;const oval=[10,338,297,332,284,251,389,356,454,323,361,288,397,365,379,378,400,377,152,148,176,149,150,136,172,58,132,93,234,127,162,21,54,103,67,109];ctx.beginPath();for(let i=0;i<oval.length;i++){const p=lm[oval[i]],x=p.x*E.canvas.width,y=p.y*E.canvas.height;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y)}ctx.closePath();ctx.stroke()}ctx.restore()}

async function startCamera(){try{E.loadingOverlay.style.display='flex';E.loadText.textContent='Requesting camera...';const st=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720,facingMode:'user'}});STATE.videoStream=st;E.webcam.srcObject=st;E.loadText.textContent='Initializing Face Mesh...';STATE.faceMesh=new FaceMesh({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});STATE.faceMesh.setOptions({maxNumFaces:1,refineLandmarks:true,minDetectionConfidence:0.5,minTrackingConfidence:0.5});STATE.faceMesh.onResults(onFaceMeshResults);await new Promise(res=>{E.webcam.onloadedmetadata=res});E.canvas.width=E.webcam.videoWidth;E.canvas.height=E.webcam.videoHeight;E.loadingOverlay.style.display='none';E.startBtn.disabled=true;E.analyzeBtn.disabled=false;updateStatus('idle','READY');showAlert('success','Camera initialized!')}catch(err){console.error('Camera error:',err);E.loadingOverlay.style.display='none';showAlert('error','Failed to access camera: '+err.message)}}

async function startAnalysis(){STATE.isAnalyzing=true;STATE.startTime=Date.now();resetState();E.analyzeBtn.disabled=true;E.stopBtn.disabled=false;E.videoContainer.className='video-container analyzing';updateStatus('analyzing','ANALYZING');const processFrame=async()=>{if(!STATE.isAnalyzing)return;if(E.webcam.readyState===E.webcam.HAVE_ENOUGH_DATA){await STATE.faceMesh.send({image:E.webcam})}STATE.animationFrameId=requestAnimationFrame(processFrame)};processFrame();STATE.metricsInterval=setInterval(updateMetrics,200);showAlert('warning','Analysis started. Stay still.')}

function stopAnalysis(){STATE.isAnalyzing=false;if(STATE.animationFrameId){cancelAnimationFrame(STATE.animationFrameId);STATE.animationFrameId=null}if(STATE.metricsInterval){clearInterval(STATE.metricsInterval);STATE.metricsInterval=null}if(STATE.videoStream){STATE.videoStream.getTracks().forEach(t=>t.stop());STATE.videoStream=null}E.webcam.srcObject=null;E.startBtn.disabled=false;E.analyzeBtn.disabled=true;E.stopBtn.disabled=true;E.videoContainer.className='video-container';updateStatus('idle','STOPPED');showAlert('warning','Analysis stopped.')}

document.querySelectorAll('input[name="detectionMethod"]').forEach(r=>{r.addEventListener('change',(e)=>{STATE.detectionMethod=e.target.value;const names={'gmm':'GMM Classifier','neural':'Neural Network','hybrid':'Hybrid Mode'};E.currentMethod.textContent=names[STATE.detectionMethod];console.log('üîÑ Switched to:',names[STATE.detectionMethod])})});

E.startBtn.addEventListener('click',startCamera);
E.analyzeBtn.addEventListener('click',startAnalysis);
E.stopBtn.addEventListener('click',stopAnalysis);

console.log('üõ° rPPG Liveness Detection System');
console.log('üìä Two-Input Model: signal[1,1024,1] + features[1,20,1]');
console.log('üß† Neural Network: 98.27% AUC, 3.89% EER');
loadNeuralModel();
</script>
</body>
</html>
